<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DREAM OS v13.4 ‚Äî Quantum Edition</title>
    
    <!-- SUPABASE CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- QR CODE SCANNER -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/npm/twemoji@latest/assets/svg/1f4bb.svg">
    
    <!-- PWA CONFIG -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0A0F2C">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DREAM OS">

    <style>
        :root {
            --emerald: #00C897; --gold: #FFD700; --dark: #0A0F2C;
            --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --blue: #3b82f6; --purple: #8b5cf6; --excel-green: #217346;
            --ghost-bg: rgba(10, 15, 44, 0.98); --glass: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }

        body {
            background: radial-gradient(circle at center, #1a1f3c 0%, #0A0F2C 100%);
            color: white; min-height: 100vh; overflow-x: hidden; position: relative;
        }

        .arabic-header {
            text-align: center; padding: 15px; background: linear-gradient(90deg, transparent, rgba(0, 200, 151, 0.1), transparent);
            border-bottom: 2px solid var(--emerald); margin-bottom: 5px; position: relative; z-index: 10;
        }

        .bismillah {
            font-family: 'Amiri', serif; font-size: 2.2rem; color: var(--gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); cursor: pointer; transition: transform 0.3s;        }
        .bismillah:hover { transform: scale(1.03); }

        .shalawat {
            font-family: 'Amiri', serif; font-size: 1.2rem; color: rgba(255, 255, 255, 0.9);
            margin: 8px 0 5px 0; line-height: 1.5;
        }

        .system-title {
            color: var(--emerald); font-size: 1.5rem; letter-spacing: 1px;
        }

        .dflash-slider {
            display: flex; overflow-x: auto; scroll-snap-type: x mandatory;
            padding: 10px; gap: 10px; background: rgba(0,0,0,0.2); scrollbar-width: none;
        }
        .dflash-slider::-webkit-scrollbar { display: none; }

        .slide {
            min-width: 85%; scroll-snap-align: center; padding: 15px;
            border-radius: 12px; background: var(--glass); border-left: 4px solid var(--emerald);
            font-size: 0.9rem; line-height: 1.4;
        }
        .urgent-slide { 
            border-left-color: var(--danger); background: rgba(239, 68, 68, 0.1); 
            animation: emergency-pulse 2s infinite;
        }

        @keyframes emergency-pulse {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }

        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ghost-bg); backdrop-filter: blur(10px); display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; padding: 20px; pointer-events: auto;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05); border: 2px solid var(--emerald);
            border-radius: 20px; padding: 30px 25px; width: 90%; max-width: 450px;
            text-align: center; animation: slideUp 0.5s ease; position: relative; z-index: 2001;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }        }

        .login-icon { font-size: 3.5rem; margin-bottom: 15px; display: block; }

        .fingerprint-btn {
            background: rgba(0, 200, 151, 0.1); border: 2px solid var(--emerald);
            border-radius: 50%; width: 75px; height: 75px; display: flex;
            align-items: center; justify-content: center; font-size: 2.2rem;
            margin: 15px auto; cursor: pointer; transition: all 0.3s;
        }
        .fingerprint-btn:hover {
            background: rgba(0, 200, 151, 0.2); transform: scale(1.1); box-shadow: 0 0 15px var(--emerald);
        }

        .pass-input {
            width: 100%; padding: 12px 18px; background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--emerald); border-radius: 10px; color: white;
            font-size: 1rem; margin: 12px 0; letter-spacing: 1px; text-align: center;
            position: relative; padding-right: 50px;
        }

        #togglePass {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
            cursor: pointer; font-size: 1.4rem; color: #ccc; transition: color 0.3s;
            z-index: 10;
        }
        #togglePass:hover { color: var(--gold); transform: scale(1.15); }

        .login-btn {
            background: var(--emerald); color: white; border: none; padding: 14px 35px;
            border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer;
            width: 100%; margin-top: 10px; transition: background 0.3s; z-index: 1002;
        }
        .login-btn:hover { background: #00b386; }

        .role-hint {
            margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.2);
            border-radius: 10px; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);
            text-align: left; display: none;
        }

        #dashboard { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; }

        .main-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px; margin: 25px 0;
        }

        .icon-box {
            background: var(--glass); border-radius: 18px; padding: 20px 15px;            text-align: center; border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
            transition: all 0.3s; min-height: 160px; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .icon-box:hover {
            border-color: var(--emerald); transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 200, 151, 0.2);
        }

        .icon-emoji { font-size: 2.8rem; margin-bottom: 10px; }

        .icon-label { font-size: 0.85rem; font-weight: bold; color: white; }

        .footer {
            margin-top: 30px; padding: 20px; text-align: center; font-size: 0.7rem;
            color: rgba(255,255,255,0.5); border-top: 1px solid rgba(255,215,0,0.1);
        }

        .form-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(15px);
            display: none; justify-content: center; align-items: center;
            z-index: 1999; padding: 20px;
        }
        .form-modal.active { display: flex; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-container {
            background: rgba(255, 255, 255, 0.05); border: 2px solid var(--emerald);
            border-radius: 20px; padding: 30px; width: 90%; max-width: 800px;
            max-height: 90vh; overflow-y: auto; position: relative;
        }

        .form-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--emerald);
        }

        .form-title {
            font-size: 1.8rem; color: white; display: flex; align-items: center; gap: 15px;
        }

        .close-modal {
            background: none; border: none; color: var(--danger); font-size: 2.5rem;
            cursor: pointer; line-height: 1; padding: 0 10px;
        }

        .form-group { margin: 20px 0; }
        .form-label {
            display: block; margin-bottom: 10px; font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 15px; background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px;
            color: white; font-size: 1rem;
        }

        .form-textarea { min-height: 120px; resize: vertical; }

        .form-submit {
            background: var(--emerald); color: white; border: none; padding: 16px 40px;
            border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer;
            width: 100%; margin-top: 20px; transition: background 0.3s;
        }
        .form-submit:hover { background: #00b386; }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            border-radius: 10px; background: rgba(0, 200, 151, 0.1);
            border: 1px solid var(--emerald); color: white; z-index: 3000;
            display: none; align-items: center; gap: 10px; max-width: 400px;
            animation: slideInRight 0.3s ease;
        }
        .notification.show { display: flex; }
        .notification.error { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        .notification.warning { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); }
        .notification.success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .connection-status {
            position: fixed; bottom: 20px; right: 20px; padding: 8px 15px;
            border-radius: 20px; font-size: 0.8rem; display: flex;
            align-items: center; gap: 8px; z-index: 1000;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
        }
        .connection-status.online { color: var(--success); border: 1px solid var(--success); }
        .connection-status.offline { color: var(--danger); border: 1px solid var(--danger); }

        #ghostConsole {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98); z-index: 2002; display: none;
            padding: 20px; font-family: 'Courier New', monospace; color: #00ff00;            overflow-y: auto;
        }

        .ghost-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 2px solid #333; margin-bottom: 20px;
        }

        .ghost-title {
            color: var(--gold); font-size: 1.8rem; display: flex; align-items: center; gap: 10px;
        }

        .ghost-close {
            background: var(--danger); color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        .log-container {
            background: rgba(0, 20, 0, 0.3); border-radius: 10px; padding: 15px;
            margin-bottom: 20px; max-height: 400px; overflow-y: auto;
        }

        .log-entry {
            padding: 10px; margin-bottom: 10px; border-left: 3px solid #00ff00;
            background: rgba(255, 255, 255, 0.05); border-radius: 5px;
        }

        .log-time { color: #888; font-size: 0.8rem; }
        .log-actor { color: var(--gold); font-weight: bold; }
        .log-action { color: #ccc; }
        .log-status { color: #00ff00; font-weight: bold; }

        #qrScanner {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 15px;
            z-index: 2003; display: none; border: 3px solid var(--emerald);
        }
        #qrScanner.active { display: block; }

        .weather-display {
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8); margin-top: 10px;
        }

        .weather-icon { font-size: 1.5rem; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 18px;
            display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-3px); border-color: var(--emerald);
        }

        .stat-icon {
            font-size: 2rem; width: 50px; height: 50px; display: flex;
            align-items: center; justify-content: center; background: rgba(0, 200, 151, 0.1);
            border-radius: 10px;
        }

        .stat-info { flex: 1; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: var(--emerald); }
        .stat-label { font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); }

        .excel-section {
            margin: 30px 0; background: white; border-radius: 10px;
            overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .excel-header {
            background: var(--excel-green); color: white; padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .excel-title { font-weight: bold; font-size: 1.1rem; }
        .excel-export-btn {
            background: white; color: var(--excel-green); border: none; padding: 6px 12px;
            border-radius: 5px; cursor: pointer; font-weight: bold; display: flex;
            align-items: center; gap: 6px; font-size: 0.9rem;
        }

        .excel-container { overflow-x: auto; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; color: #333; min-width: 700px; }
        .excel-table th {
            background: #f0f0f0; color: #333; padding: 10px 12px; border: 1px solid #ddd;
            text-align: left; font-weight: bold; white-space: nowrap;
        }
        .excel-table td { padding: 8px 12px; border: 1px solid #ddd; vertical-align: top; }
        .excel-table tr:nth-child(even) { background: #f9f9f9; }
        .excel-table tr:hover { background: #f0f8ff; }

        .status-badge {
            padding: 3px 8px; border-radius: 15px; font-size: 0.7rem; font-weight: bold;
        }        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }

        .area-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px; margin: 15px 0;
        }

        .area-item {
            background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .area-name {
            font-weight: bold; color: var(--emerald); margin-bottom: 10px; font-size: 1rem;
        }

        .status-options { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .status-option { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .status-option input[type="radio"] { accent-color: var(--emerald); }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .bismillah { font-size: 1.9rem; }
            .shalawat { font-size: 1rem; }
        }

        @media (max-width: 480px) {
            .main-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .login-box { padding: 25px 20px; }
            .bismillah { font-size: 1.7rem; }
            .shalawat { font-size: 0.9rem; }
            .form-container { padding: 20px; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--emerald); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #00b386; }
    </style>
</head>
<body>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification">
        <span id="notificationIcon">‚ÑπÔ∏è</span>
        <span id="notificationText">Notification</span>    </div>

    <!-- CONNECTION STATUS -->
    <div class="connection-status offline" id="connectionStatus">
        <span id="connectionIcon">üì¥</span>
        <span id="connectionText">Offline Mode</span>
    </div>

    <!-- HEADER BISMILLAH -->
    <header class="arabic-header" id="bismillah-trigger">
        <div class="bismillah">Ô∑Ω</div>
        <div class="shalawat">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸÄŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê<br>ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿµŸéŸÑŸêŸë ÿπŸéŸÑŸéŸâ ÿ≥ŸéŸäŸêŸëÿØŸêŸÜŸéÿß ŸÖŸèÿ≠ŸéŸÖŸéŸëÿØŸç</div>
        <div class="system-title">DREAM OS v13.4 ‚Äî Quantum Edition</div>
        <div class="weather-display" id="weatherDepok">
            <span class="weather-icon">üå§Ô∏è</span>
            <span id="weatherText">üìç Depok: Loading weather...</span>
        </div>
    </header>

    <!-- DFLASH SLIDING HEADER -->
    <div class="dflash-slider" id="smartSlider">
        <div class="slide">
            <span style="color: var(--gold); font-weight:bold;">üëã Assalamualaikum, Team!</span><br>
            Keluarga Besar SIF Al-Fikri | Quantum Bridge Active
        </div>
        <div class="slide" id="weatherSlide">
            <span style="color: var(--blue); font-weight:bold;">üå¶Ô∏è BMKG LIVE - TITIK 0 AF</span><br>
            Sedang memuat data cuaca presisi...
        </div>
        <div class="slide urgent-slide" id="disasterSlide">
            <span style="color: var(--danger); font-weight:bold;">üö® EMERGENCY ALERT</span><br>
            Pantau Gempa & Cuaca Buruk Depok.
        </div>
    </div>

    <!-- LOGIN OVERLAY - REVISI TOTAL -->
    <div id="login-overlay">
        <div class="login-box">
            <span class="login-icon">üß¨</span>
            <h2 style="color: var(--gold); margin-bottom: 10px; font-family: 'Amiri', serif; font-size: 1.8rem;">SMART BIOMETRIC ACCESS</h2>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 25px; font-size: 0.95rem;">
                Gunakan Fingerprint Redmi Note 9 Pro atau Password Role
            </p>
            
            <div class="fingerprint-btn" onclick="simulateFingerprint()">
                üëÜ
            </div>
            <div style="font-size: 0.85rem; color: var(--emerald); margin: 10px 0 20px; font-weight: bold;">
                Tap untuk Fingerprint Detection
            </div>            
            <div style="position: relative; width: 100%; margin-bottom: 20px;">
                <input type="password" class="pass-input" id="passInput" 
                       placeholder="Masukkan Password Role..." 
                       onkeypress="handleEnterKey(event)">
                <span id="togglePass" onclick="togglePasswordVisibility()" 
                      style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.4rem; color: #ccc; transition: color 0.3s;">
                    üëÅÔ∏è
                </span>
            </div>
            
            <button class="login-btn" onclick="handleLogin()">
                üîì MASUK SISTEM
            </button>
            
            <div id="ghostHint" class="role-hint" style="display: none; margin-top: 20px; background: rgba(0,0,0,0.3); border: 1px solid rgba(139,92,246,0.5);">
                <strong style="color: var(--purple); display: block; margin-bottom: 8px; font-size: 0.9rem;">üëª Ghost Mode Active</strong>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8);">
                    <div>Ketuk Bismillah 3x untuk menampilkan hint</div>
                    <div style="margin-top: 5px; color: var(--gold); font-weight: bold;">System Operator: Master M üòé</div>
                </div>
            </div>
            
            <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; color: rgba(255,255,255,0.4);">
                <div>DREAM OS v13.4 ‚Äî Quantum Edition</div>
                <div>ISO Standard ‚Ä¢ High Risk Compliant</div>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <main id="dashboard">
        <div class="dashboard-header">
            <div class="user-badge">
                <span id="currentRoleIcon">üë§</span>
                <span>Logged as: <strong id="currentUserName">Guest</strong></span>
                <span style="color: var(--emerald);"> | Role: <strong id="currentUserRole">Unknown</strong></span>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="refreshDashboard()" style="background: rgba(0,200,151,0.1); color: var(--emerald); border: 1px solid var(--emerald); padding: 10px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    üîÑ Refresh
                </button>
                <button class="logout-btn" onclick="logout()" style="background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- LIVE STATS -->        <div class="stats-grid" id="statsGrid">
            <!-- Stats akan diisi oleh JavaScript -->
        </div>

        <!-- 7-ICON GRID -->
        <div class="main-grid" id="iconGrid">
            <!-- Icons akan diisi oleh JavaScript -->
        </div>

        <!-- WINDOWS EXCEL VIEW (SECURITY) -->
        <div class="excel-section" id="excelView" style="display: none;">
            <div class="excel-header">
                <div class="excel-title">üìä LAPORAN HARIAN SEKURITI - EXCEL VIEW</div>
                <button class="excel-export-btn" onclick="exportToExcel()">
                    üì• Export Excel
                </button>
            </div>
            <div class="excel-container">
                <table class="excel-table" id="excelTable">
                    <!-- Excel content akan diisi oleh JavaScript -->
                </table>
            </div>
        </div>
    </main>

    <!-- FORM MODAL -->
    <div class="form-modal" id="formModal">
        <div class="form-container" id="formContainer">
            <!-- Form content akan diisi oleh JavaScript -->
        </div>
    </div>

    <!-- QR SCANNER -->
    <div id="qrScanner">
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: var(--emerald);">üì∑ QR Code Scanner</h3>
            <p style="color: rgba(255,255,255,0.7);">Scan barcode inventaris mesin</p>
        </div>
        <div id="qrReader" style="width: 300px; height: 300px;"></div>
        <button onclick="closeQRScanner()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 20px;">
            ‚úï Close Scanner
        </button>
    </div>

    <!-- GHOST CONSOLE -->
    <div id="ghostConsole">
        <div class="ghost-header">
            <div class="ghost-title">
                üëª GHOST ARCHITECT CONSOLE v1.0
                <span style="font-size: 0.8rem; color: #888;">[Stealth Mode Active]</span>            </div>
            <button class="ghost-close" onclick="closeGhostConsole()">‚úï CLOSE</button>
        </div>
        
        <div class="log-container" id="ghostLogs">
            <!-- Logs akan diisi oleh JavaScript -->
        </div>
        
        <div style="background: rgba(255,0,0,0.1); padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3 style="color: #ff4444;">‚ö†Ô∏è EMERGENCY CONTROLS</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                <button onclick="forceUnlockSystem()" style="background: #333; color: var(--gold); border: 1px solid var(--gold); padding: 12px; border-radius: 5px; cursor: pointer;">
                    üîì Force Unlock All
                </button>
                <button onclick="purgeAllData()" style="background: #660000; color: white; border: 1px solid #ff4444; padding: 12px; border-radius: 5px; cursor: pointer;">
                    ‚ö° Emergency Purge
                </button>
                <button onclick="simulateAlert()" style="background: #333; color: #00ff00; border: 1px solid #00ff00; padding: 12px; border-radius: 5px; cursor: pointer;">
                    üö® Simulate Alert
                </button>
                <button onclick="showSystemInfo()" style="background: #333; color: #00aaff; border: 1px solid #00aaff; padding: 12px; border-radius: 5px; cursor: pointer;">
                    üìä System Info
                </button>
            </div>
        </div>
    </div>

    <!-- FOOTER ISO -->
    <div class="footer">
        <div>‚ú® THE DREAM TEAM - THE POWER SOUL OF SHALAWAT ‚ú®</div>
        <div>Kepala Bagian Umum: Bapak Hanung Budianto S. E</div>
        <div>Koordinator Bagian Umum: Bapak Erwinsyah</div>
        <div style="margin-top:8px; letter-spacing:1px; color:var(--gold);">
            SYSTEM COMPLIANT WITH ISO STANDARDS ‚Ä¢ 2026
        </div>
    </div>

    <script>
        // ================= CORE VARIABLES =================
        const SUPABASE_URL = 'https://vgfzyuswsjrjmtbwrvpc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnZnp5dXN3c2pyam10YndydnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNjg0NTcsImV4cCI6MjA4Mzk0NDQ1N30.nZQ-M9VZ2_Wa4ws5qzZy2cKXVcc_d6aGeY6mQ3Q7RJk';
        
        let supabase = null;
        let currentUser = "Guest";
        let currentRole = "guest";
        let ghostLogs = [];
        let failedAttempts = 0;
        let isLocked = false;
        let qrScanner = null;
        let bismillahCount = 0;        let lastClickTime = 0;

        // ================= USER DATABASE =================
        const USER_DATABASE = {
            "user_@1234": { name: "User Umum", role: "user", icon: "üë§" },
            "LHPSsec_AF2025": { name: "Security Piket", role: "security", icon: "üëÆ" },
            "4dm1n_AF6969@00": { name: "Admin Master", role: "admin", icon: "üëë" },
            "CHCS_AF_@003": { name: "Janitor CS", role: "cs", icon: "üßπ" },
            "M41n_4F@234": { name: "Maintenance", role: "maintenance", icon: "üîß" },
            "SACS_AF@004": { name: "Stok Chemical", role: "stock", icon: "üì¶" },
            "4dm1n_6969@01": { name: "Inventaris", role: "inventory", icon: "üìã" },
            "4dm1n_9696@02": { name: "Gudang Pupuk", role: "warehouse", icon: "üöú" }
        };

        // ================= ICON BLUEPRINT =================
        const ICON_BLUEPRINT = [
            { id: 1, emoji: "üóìÔ∏è", title: "BOOKING SARANA", desc: "Booking 22 sarana Al-Fikri", access: ["user", "admin"] },
            { id: 2, emoji: "‚ö†Ô∏è", title: "LAPORAN K3", desc: "Kerusakan ‚Üí Maintenance<br>Kehilangan ‚Üí Security<br>Kebersihan ‚Üí CS", access: ["user", "admin", "security", "cs", "maintenance"] },
            { id: 3, emoji: "üëÆ", title: "HARIAN SEKURITI", desc: "Petugas 3 orang ‚Ä¢ Shift Pagi/Malam<br>Excel export ready", access: ["security", "admin"] },
            { id: 4, emoji: "üëî", title: "ADMIN PANEL", desc: "Akses penuh sistem<br>Device fingerprint<br>Supabase management", access: ["admin"] },
            { id: 5, emoji: "‚úÖ", title: "CEKLIS JANITOR", desc: "Ceklis harian 11 area<br>Monitoring kebersihan", access: ["cs", "admin"] },
            { id: 6, emoji: "üßπ", title: "STOK & ALAT CS", desc: "Stok & tools kebersihan<br>Chemical & pupuk inventory", access: ["stock", "inventory", "warehouse", "admin"] },
            { id: 7, emoji: "üõ†Ô∏è", title: "MAINTENANCE", desc: "Perbaikan sarana<br>Status tracking<br>QR code scanner", access: ["maintenance", "admin"] }
        ];

        // ================= INITIALIZATION =================
        window.addEventListener('load', () => {
            initializeSystem();
            setupGhostAccess();
            loadWeatherData();
            updateConnectionStatus(navigator.online);
            window.addEventListener('online', () => updateConnectionStatus(true));
            window.addEventListener('offline', () => updateConnectionStatus(false));
        });

        function initializeSystem() {
            // Initialize Supabase
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                updateConnectionStatus(true);
                showNotification('‚úÖ Connected to Supabase', 'success', 2000);
                logToGhost('SYSTEM', 'Supabase initialized', 'SUCCESS');
            } catch (error) {
                console.error('Supabase init error:', error);
                updateConnectionStatus(false);
                showNotification('‚ö†Ô∏è Offline mode active', 'warning', 2000);
                logToGhost('SYSTEM', 'Supabase offline', 'WARNING');
            }

            // Check for existing session            const savedUser = localStorage.getItem('dreamos_session');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    loginSuccess(userData);
                } catch (e) {
                    localStorage.removeItem('dreamos_session');
                }
            }
            
            // Load dashboard stats
            setTimeout(loadDashboardStats, 1000);
        }

        // ================= AUTHENTICATION SYSTEM =================
        function togglePasswordVisibility() {
            const passInput = document.getElementById('passInput');
            const toggleIcon = document.getElementById('togglePass');
            
            if (passInput.type === "password") {
                passInput.type = "text";
                toggleIcon.textContent = "üîí";
                toggleIcon.style.color = "var(--danger)";
            } else {
                passInput.type = "password";
                toggleIcon.textContent = "üëÅÔ∏è";
                toggleIcon.style.color = "#ccc";
            }
            
            logToGhost('UI', 'Password visibility toggled', 'ACTION');
        }

        function handleLogin() {
            const passInput = document.getElementById('passInput');
            const password = passInput.value.trim();
            
            if (!password) {
                showNotification('‚ùå Password tidak boleh kosong!', 'error', 3000);
                passInput.focus();
                return;
            }

            if (isLocked) {
                showNotification('üö´ Sistem terkunci! Tunggu 5 menit.', 'error', 3000);
                return;
            }

            const userInfo = USER_DATABASE[password];
            if (userInfo) {
                failedAttempts = 0;                showNotification('‚úÖ Password diterima! Mengakses sistem...', 'success', 2000);
                setTimeout(() => {
                    loginSuccess(userInfo);
                }, 500);
            } else {
                failedAttempts++;
                showNotification(`‚ùå Password ditolak (${failedAttempts}/3)`, 'error', 3000);
                logToGhost('AUTH', `Invalid password: ${password.substring(0, 3)}...`, 'BLOCKED');
                
                // Visual feedback
                passInput.style.borderColor = 'var(--danger)';
                passInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    passInput.style.borderColor = 'var(--emerald)';
                    passInput.style.animation = 'none';
                }, 500);
                
                if (failedAttempts >= 3) {
                    triggerLockout();
                }
            }
        }

        function triggerLockout() {
            isLocked = true;
            const passInput = document.getElementById('passInput');
            passInput.disabled = true;
            passInput.style.backgroundColor = 'rgba(100,0,0,0.3)';
            
            showNotification('üö´ SISTEM TERKUNCI: 5 menit cooldown!', 'error', 3000);
            logToGhost('SECURITY', 'System locked after 3 failed attempts', 'CRITICAL');
            
            setTimeout(() => {
                isLocked = false;
                failedAttempts = 0;
                passInput.disabled = false;
                passInput.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
                showNotification('üîì Sistem kembali aktif', 'success', 2000);
            }, 300000);
        }

        function simulateFingerprint() {
            const isXiaomiDevice = navigator.userAgent.includes('Redmi') || 
                                  navigator.userAgent.includes('Mi') ||
                                  navigator.platform.includes('Android');
            
            const fingerStatus = document.querySelector('.fingerprint-btn + div');
            if (fingerStatus) {
                fingerStatus.innerHTML = '<span style="color: var(--gold);">üåÄ SCANNING BIOMETRIK...</span>';
            }            
            setTimeout(() => {
                if (isXiaomiDevice) {
                    // Auto-login as admin for Redmi devices
                    loginSuccess(USER_DATABASE["4dm1n_AF6969@00"]);
                    showNotification('‚úÖ Fingerprint terdeteksi! Akses diberikan.', 'success', 2000);
                } else {
                    showNotification('üì± Hanya Redmi Note 9 Pro yang bisa pakai fingerprint!', 'warning', 3000);
                    if (fingerStatus) {
                        fingerStatus.innerHTML = 'Tap untuk Fingerprint Detection';
                        fingerStatus.style.color = 'var(--emerald)';
                    }
                }
            }, 1200);
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') handleLogin();
        }

        function loginSuccess(user) {
            currentUser = user.name;
            currentRole = user.role;
            
            localStorage.setItem('dreamos_session', JSON.stringify(user));
            localStorage.setItem('last_login', Date.now().toString());
            
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = user.role.toUpperCase();
            document.getElementById('currentRoleIcon').textContent = user.icon;
            
            renderIconGrid();
            showNotification(`‚úÖ Selamat datang, ${user.name}!`, 'success', 3000);
            logToGhost('AUTH', `Login success: ${user.name}`, 'SUCCESS');
            
            // Show Excel view for security & admin
            if (currentRole === 'security' || currentRole === 'admin') {
                document.getElementById('excelView').style.display = 'block';
                generateExcelView();
            }
            
            // Update Ghost Mode status
            const ghostHint = document.getElementById('ghostHint');
            if (currentRole === 'admin' && ghostHint) {
                ghostHint.style.display = 'block';
                setTimeout(() => {
                    ghostHint.style.display = 'none';                }, 5000);
            }
        }

        function logout() {
            if (confirm('Konfirmasi logout dari DREAM OS?')) {
                currentUser = "Guest";
                currentRole = "guest";
                localStorage.removeItem('dreamos_session');
                location.reload();
            }
        }

        // ================= ICON GRID MANAGEMENT =================
        function renderIconGrid() {
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = '';
            
            ICON_BLUEPRINT.forEach(icon => {
                const hasAccess = icon.access.includes(currentRole) || currentRole === 'admin';
                const card = document.createElement('div');
                card.className = `icon-box ${hasAccess ? '' : 'locked'}`;
                
                if (hasAccess) {
                    card.onclick = () => openModule(icon.id);
                    card.style.cursor = 'pointer';
                } else {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                }
                
                card.innerHTML = `
                    <div class="icon-emoji">${icon.emoji}</div>
                    <div class="icon-label">${icon.title}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        function openModule(moduleId) {
            const modules = {
                1: "BOOKING SARANA",
                2: "LAPORAN K3",
                3: "HARIAN SEKURITI",
                4: "ADMIN PANEL",
                5: "CEKLIS JANITOR",
                6: "STOK & ALAT CS",
                7: "MAINTENANCE"
            };            
            const moduleContent = getModuleContent(moduleId);
            document.getElementById('formContainer').innerHTML = moduleContent;
            document.getElementById('formModal').classList.add('active');
            
            showNotification(`üìÇ Membuka ${modules[moduleId]}...`, 'info', 2000);
            logToGhost('MODULE', `Opened: ${modules[moduleId]}`, 'ACTION');
        }

        function getModuleContent(moduleId) {
            switch(moduleId) {
                case 5: // CEKLIS JANITOR - WINDOWS XL STYLE
                    return `
                        <div class="form-header">
                            <div class="form-title">
                                <span>‚úÖ</span>
                                <div>CEKLIS HARIAN CLEANING SERVICE</div>
                            </div>
                            <button class="close-modal" onclick="closeModal()">√ó</button>
                        </div>
                        
                        <div style="background: white; border-radius: 0 0 12px 12px; padding: 20px; margin-top: -1px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--excel-green);">
                                <div style="font-weight: bold; color: #333;">
                                    <div style="font-size: 1.1rem;">üìã LAPORAN HARIAN CS - 11 AREA</div>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">Standar ISO 9001:2015 ‚Ä¢ Al-Fikri Depok</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: var(--excel-green);">TANGGAL: <span id="currentDate">${new Date().toLocaleDateString('id-ID')}</span></div>
                                    <div style="font-size: 0.85rem; color: #666;">SHIFT: <span id="currentShift">${getShiftName()}</span></div>
                                </div>
                            </div>
                            
                            <div style="overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <table class="excel-table" style="width: 100%; border-collapse: collapse; min-width: 850px;">
                                    <thead>
                                        <tr style="background: var(--excel-green); color: white;">
                                            <th style="padding: 12px 15px; border: 1px solid #ddd; width: 5%; text-align: center;">NO</th>
                                            <th style="padding: 12px 15px; border: 1px solid #ddd; width: 25%; text-align: left;">AREA KEBERSIHAN</th>
                                            <th style="padding: 12px 15px; border: 1px solid #ddd; width: 20%; text-align: center;">STATUS</th>
                                            <th style="padding: 12px 15px; border: 1px solid #ddd; width: 35%; text-align: left;">CATATAN KHUSUS</th>
                                            <th style="padding: 12px 15px; border: 1px solid #ddd; width: 15%; text-align: center;">FOTO</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csTableBody">
                                        ${generateCSTableRows()}
                                    </tbody>
                                </table>
                            </div>
                                                        <div style="margin: 25px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid var(--excel-green);">
                                <div style="font-weight: bold; color: #333; margin-bottom: 8px;">üìù Petunjuk Pengisian:</div>
                                <div style="font-size: 0.9rem; color: #666; line-height: 1.6;">
                                    ‚Ä¢ Pilih status untuk setiap area: <span style="color: green; font-weight: bold;">‚úÖ Bersih</span> | <span style="color: red; font-weight: bold;">‚ùå Kotor</span> | <span style="color: #ff9800; font-weight: bold;">üîß Perbaikan</span><br>
                                    ‚Ä¢ Isi catatan khusus jika diperlukan<br>
                                    ‚Ä¢ Upload foto dokumentasi sebelum & sesudah cleaning<br>
                                    ‚Ä¢ Tekan "üíæ SIMPAN LAPORAN" untuk menyimpan ke sistem
                                </div>
                            </div>
                            
                            <button type="button" class="form-submit" onclick="submitCSForm()">
                                üíæ SIMPAN LAPORAN KE SERVER
                            </button>
                        </div>
                    `;
                default:
                    return `
                        <div class="form-header">
                            <div class="form-title">
                                <span>${ICON_BLUEPRINT[moduleId-1].emoji}</span>
                                <div>${ICON_BLUEPRINT[moduleId-1].title}</div>
                            </div>
                            <button class="close-modal" onclick="closeModal()">√ó</button>
                        </div>
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 3rem; margin-bottom: 20px;">${ICON_BLUEPRINT[moduleId-1].emoji}</div>
                            <h3>${ICON_BLUEPRINT[moduleId-1].title}</h3>
                            <p style="margin: 20px 0; color: rgba(255,255,255,0.7);">
                                [Form implementation in progress]
                            </p>
                            <button onclick="closeModal()" class="form-submit">
                                CLOSE
                            </button>
                        </div>
                    `;
            }
        }

        function getShiftName() {
            const hour = new Date().getHours();
            return hour < 14 ? 'Pagi (06:00-14:00)' : 
                   hour < 22 ? 'Sore (14:00-22:00)' : 'Malam (22:00-06:00)';
        }

        function generateCSTableRows() {
            const areas = [
                { id: 1, name: "Pintu Utama", desc: "Pintu masuk utama & area lobby" },
                { id: 2, name: "Pintu Kubikal", desc: "Pintu toilet & kamar mandi" },
                { id: 3, name: "Kaca / Cermin", desc: "Semua kaca & cermin gedung" },
                { id: 4, name: "Exhaust", desc: "Ventilasi kamar mandi & dapur" },                { id: 5, name: "Dinding", desc: "Dinding dalam & luar gedung" },
                { id: 6, name: "Tempat Wudhu", desc: "Area wudhu masjid & toilet" },
                { id: 7, name: "Lantai", desc: "Semua lantai area gedung" },
                { id: 8, name: "Floor Drain", desc: "Saluran air lantai" },
                { id: 9, name: "Kloset", desc: "Kloset & urinoir toilet" },
                { id: 10, name: "Flapond / Ceiling", desc: "Plafon & langit-langit" },
                { id: 11, name: "Tempat Sampah", desc: "Tempat sampah kering & basah" }
            ];
            
            return areas.map((area, index) => `
                <tr>
                    <td style="text-align: center; font-weight: bold; background: #f8f9fa;">${index + 1}</td>
                    <td>
                        <div style="font-weight: bold; color: #333;">${area.name}</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">${area.desc}</div>
                    </td>
                    <td style="text-align: center;">
                        <select class="status-select" style="width: 100%; padding: 6px; border-radius: 4px;">
                            <option value="bersih">‚úÖ Bersih</option>
                            <option value="kotor" selected>‚ùå Kotor</option>
                            <option value="perbaikan">üîß Perlu Perbaikan</option>
                        </select>
                    </td>
                    <td>
                        <textarea placeholder="Catatan khusus..." 
                            style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9rem;"
                            rows="2"></textarea>
                    </td>
                    <td style="text-align: center;">
                        <input type="file" accept="image/*" capture="environment" 
                            style="width: 100%; padding: 5px; background: #f8f9fa; border: 1px dashed #ddd; border-radius: 4px;">
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">üì∏ Sebelum/Sesudah</div>
                    </td>
                </tr>
            `).join('');
        }

        function submitCSForm() {
            showNotification('üíæ Sedang menyimpan laporan...', 'info', 2000);
            
            // Simulate saving to Supabase
            setTimeout(() => {
                showNotification('‚úÖ Laporan CS 11 area berhasil disimpan!', 'success', 3000);
                closeModal();
                logToGhost('CS', 'CS checklist submitted (11 areas)', 'SUCCESS');
                
                // Optional: Refresh dashboard stats
                loadDashboardStats();
            }, 1500);
        }
        function closeModal() {
            document.getElementById('formModal').classList.remove('active');
        }

        // ================= GHOST CONSOLE SYSTEM =================
        function setupGhostAccess() {
            const bismillah = document.getElementById('bismillah-trigger');
            bismillah.addEventListener('click', (e) => {
                e.stopPropagation();
                const now = Date.now();
                
                // Reset counter if last click was >1 second ago
                if (now - lastClickTime > 1000) {
                    bismillahCount = 0;
                }
                
                bismillahCount++;
                lastClickTime = now;
                
                if (bismillahCount === 3) {
                    bismillahCount = 0;
                    const ghostHint = document.getElementById('ghostHint');
                    if (ghostHint) {
                        ghostHint.style.display = 'block';
                        showNotification('üëª Ghost Mode Activated!', 'warning', 3000);
                        logToGhost('GHOST', 'Triple-click Bismillah detected', 'ACCESS');
                        
                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            ghostHint.style.display = 'none';
                        }, 5000);
                    }
                }
            });
        }

        function openGhostConsole() {
            document.getElementById('ghostConsole').style.display = 'block';
            updateGhostLogs();
            logToGhost('SYSTEM', 'Ghost Console opened', 'INFO');
        }

        function closeGhostConsole() {
            document.getElementById('ghostConsole').style.display = 'none';
        }

        function logToGhost(actor, action, status) {
            const entry = {
                time: new Date().toLocaleTimeString('id-ID'),                actor,
                action,
                status
            };
            ghostLogs.unshift(entry);
            if (ghostLogs.length > 50) ghostLogs.pop();
            
            if (document.getElementById('ghostConsole').style.display === 'block') {
                updateGhostLogs();
            }
            
            console.log(`üëª [${entry.time}] ${actor}: ${action} [${status}]`);
        }

        function updateGhostLogs() {
            const container = document.getElementById('ghostLogs');
            container.innerHTML = ghostLogs.map(log => `
                <div class="log-entry">
                    <div class="log-time">[${log.time}]</div>
                    <div>
                        <span class="log-actor">${log.actor}</span>
                        <span class="log-action"> ‚Üí ${log.action}</span>
                    </div>
                    <div class="log-status">[${log.status}]</div>
                </div>
            `).join('');
        }

        function forceUnlockSystem() {
            // Unlock all icons for admin
            if (currentRole === 'admin') {
                document.querySelectorAll('.icon-box').forEach(icon => {
                    icon.classList.remove('locked');
                    icon.style.opacity = '1';
                    icon.style.cursor = 'pointer';
                });
                showNotification('üîì All systems force unlocked!', 'warning', 2000);
                logToGhost('GHOST', 'Force unlocked all systems', 'EMERGENCY');
            } else {
                showNotification('‚ùå Hanya Admin yang bisa melakukan ini!', 'error', 2000);
                logToGhost('GHOST', 'Unauthorized force unlock attempt', 'BLOCKED');
            }
        }

        function purgeAllData() {
            if (confirm('‚ö†Ô∏è EMERGENCY PURGE - All data will be deleted! Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                ghostLogs = [];
                                showNotification('üßπ All data purged successfully', 'success', 2000);
                logToGhost('GHOST', 'Emergency purge executed', 'CRITICAL');
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        // ================= EXCEL VIEW GENERATION =================
        function generateExcelView() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const personnelCount = isWeekend ? 2 : 3;
            
            const table = document.getElementById('excelTable');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>NAMA PERSONIL</th>
                        <th>SHIFT</th>
                        <th>LOKASI</th>
                        <th>STATUS</th>
                        <th>CATATAN</th>
                        <th>WAKTU</th>
                    </tr>
                </thead>
                <tbody>
                    ${Array.from({length: personnelCount}, (_, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td contenteditable="true">Personil ${i + 1}</td>
                            <td contenteditable="true">${isWeekend ? 'LIBUR' : 'PAGI/SORE'}</td>
                            <td contenteditable="true">Gate ${i + 1}</td>
                            <td>
                                <select class="status-select" style="width:100%; padding:5px;">
                                    <option value="Active">üü¢ Active</option>
                                    <option value="Break">üü° Break</option>
                                    <option value="Off">üî¥ Off</option>
                                </select>
                            </td>
                            <td contenteditable="true">-</td>
                            <td>${new Date().toLocaleTimeString('id-ID')}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
                        // Add real-time updates
            setInterval(() => {
                document.querySelectorAll('#excelTable tbody td:last-child').forEach(td => {
                    td.textContent = new Date().toLocaleTimeString('id-ID');
                });
            }, 60000);
        }

        function exportToExcel() {
            const table = document.getElementById('excelTable');
            let csv = [];
            
            // Get headers
            const headers = [];
            table.querySelectorAll('th').forEach(th => {
                headers.push(th.textContent);
            });
            csv.push(headers.join(','));
            
            // Get rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach((td, index) => {
                    if (index === 4) { // Status column
                        const select = td.querySelector('select');
                        row.push(select ? select.value : td.textContent);
                    } else {
                        row.push(td.textContent);
                    }
                });
                csv.push(row.join(','));
            });
            
            // Download CSV
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laporan-security-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showNotification('üì• Excel exported successfully!', 'success', 2000);
            logToGhost('EXPORT', 'Security report exported to Excel', 'SUCCESS');
        }

        // ================= WEATHER & DISASTER SYSTEM =================
        function loadWeatherData() {
            try {
                // Using OpenWeatherMap API (demo - replace with actual API key)                fetch('https://api.openweathermap.org/data/2.5/weather?q=Depok,ID&units=metric&appid=demo_key&lang=id')
                .then(response => response.json())
                .then(data => {
                    if (data && data.main) {
                        const temp = Math.round(data.main.temp);
                        const desc = data.weather[0].description;
                        const icon = getWeatherIcon(data.weather[0].main);
                        
                        document.getElementById('weatherText').textContent = 
                            `üìç Depok: ${temp}¬∞C, ${desc} ${icon}`;
                            
                        document.getElementById('weatherSlide').innerHTML = `
                            <span style="color: var(--blue); font-weight:bold;">üå¶Ô∏è BMKG LIVE - TITIK 0 AF</span><br>
                            ${temp}¬∞C ‚Ä¢ ${desc} | Kelembapan: ${data.main.humidity}%
                        `;
                        
                        logToGhost('WEATHER', `Weather updated: ${temp}¬∞C, ${desc}`, 'INFO');
                        
                        // Check for extreme weather
                        if (data.weather[0].main === 'Rain' && data.main.humidity > 80) {
                            document.getElementById('disasterSlide').innerHTML = `
                                <span style="color: var(--danger); font-weight:bold;">‚ö° PETIR & HUJAN ALERT</span><br>
                                Potensi hujan lebat di koordinat Al-Fikri. Janitor: Siaga Lobby!
                            `;
                            document.getElementById('disasterSlide').classList.add('urgent-slide');
                            
                            // Send alert to relevant roles
                            if (['cs', 'security', 'admin'].includes(currentRole)) {
                                showNotification('‚ö° PETIR & HUJAN ALERT: Siapkan langkah antisipasi!', 'warning', 5000);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error("Weather fetch failed:", error);
                    document.getElementById('weatherText').textContent = 'üìç Depok: 29¬∞C, Cerah berawan üå§Ô∏è';
                });
            } catch (error) {
                console.error("Weather error:", error);
                document.getElementById('weatherText').textContent = 'üìç Depok: 29¬∞C, Cerah berawan üå§Ô∏è';
            }
        }

        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è',                'Snow': '‚ùÑÔ∏è',
                'Mist': 'üå´Ô∏è',
                'Haze': 'üå´Ô∏è'
            };
            return icons[condition] || 'üå§Ô∏è';
        }

        // ================= UTILITY FUNCTIONS =================
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            
            const icons = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            };
            
            icon.textContent = icons[type] || '‚ÑπÔ∏è';
            text.textContent = message;
            
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const icon = document.getElementById('connectionIcon');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                status.className = 'connection-status online';
                icon.textContent = 'üì°';
                text.textContent = 'Online Mode';
            } else {
                status.className = 'connection-status offline';
                icon.textContent = 'üì¥';
                text.textContent = 'Offline Mode';
            }
        }

        function refreshDashboard() {
            showNotification('üîÑ Refreshing dashboard...', 'info', 1500);
            loadDashboardStats();
            loadWeatherData();            logToGhost('SYSTEM', 'Dashboard refreshed manually', 'INFO');
        }

        function loadDashboardStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            // Mock data - in real app, fetch from Supabase
            const stats = [
                { icon: 'üìÖ', value: '12', label: 'Booking Hari Ini', color: 'emerald' },
                { icon: '‚ö†Ô∏è', value: '3', label: 'Laporan K3 Open', color: 'warning' },
                { icon: 'üëÆ', value: '5', label: 'Security Active', color: 'blue' },
                { icon: 'üì¶', value: '2', label: 'Low Stock Alert', color: 'danger' },
                { icon: '‚úÖ', value: '11/11', label: 'Area CS Checked', color: 'success' },
                { icon: 'üõ†Ô∏è', value: '4', label: 'Maintenance Pending', color: 'purple' }
            ];
            
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--${stat.color})">
                        ${stat.icon}
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                </div>
            `).join('');
        }

        // ================= QR SCANNER =================
        function startQRScanner() {
            const scanner = document.getElementById('qrScanner');
            scanner.classList.add('active');
            
            // Initialize QR scanner
            if (!qrScanner) {
                qrScanner = new Html5Qrcode("qrReader");
            }
            
            qrScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    showNotification(`üì∑ QR Code detected: ${decodedText}`, 'success', 3000);
                    logToGhost('QR', `Scanned: ${decodedText}`, 'SUCCESS');
                    
                    // Close scanner after successful scan                    setTimeout(closeQRScanner, 1000);
                },
                (errorMessage) => {
                    // Ignore initial errors
                }
            ).catch(err => {
                console.error("QR Scanner error:", err);
                showNotification('‚ùå QR Scanner failed to start', 'error', 3000);
                closeQRScanner();
            });
        }

        function closeQRScanner() {
            const scanner = document.getElementById('qrScanner');
            scanner.classList.remove('active');
            
            if (qrScanner) {
                qrScanner.stop().catch(() => {});
            }
        }

        // ================= SIMULATION FUNCTIONS =================
        function simulateAlert() {
            const alerts = [
                'üö® Emergency: Gate Utama breached!',
                '‚ö†Ô∏è Warning: Low chemical stock!',
                'üîß Alert: Maintenance needed at Aula SMP',
                'üì¶ Notice: Pupuk delivery arrived',
                'üëÆ Security: Patrol report overdue'
            ];
            
            const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
            showNotification(randomAlert, 'warning', 4000);
            logToGhost('ALERT', `Simulated: ${randomAlert}`, 'TEST');
        }

        function showSystemInfo() {
            const info = `
DREAM OS v13.4 Quantum Edition
===============================
User: ${currentUser}
Role: ${currentRole}
Browser: ${navigator.userAgent.substring(0, 50)}...
Screen: ${window.innerWidth}x${window.innerHeight}
Online: ${navigator.online ? 'Yes' : 'No'}
GPS: ${navigator.geolocation ? 'Available' : 'Not available'}
Touch: ${'ontouchstart' in window ? 'Yes' : 'No'}
Time: ${new Date().toLocaleTimeString('id-ID')}
            `;
                        alert(info);
            logToGhost('SYSTEM', 'Displayed system information', 'INFO');
        }
    </script>
</body>
</html>
